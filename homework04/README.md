# Домашнее задание #4

## Логический уровень PostgreSQL. Работа с базами данных, пользователями и правами


1. создайте новый кластер PostgreSQL 14
```
sudo apt update && sudo apt upgrade -y && sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list' && wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add - && sudo apt-get update && sudo apt-get -y install postgresql-14
```
2. зайдите в созданный кластер под пользователем postgres
3. создайте новую базу данных testdb
```
create database testdb;
```
4. зайдите в созданную базу данных под пользователем postgres
```
postgres=# \c testdb
You are now connected to database "testdb" as user "postgres".
```
5. создайте новую схему testnm
```
create schema testnm;
```
6. создайте новую таблицу t1 с одной колонкой c1 типа integer
```
create table t1 (c1 integer);
```
7. вставьте строку со значением c1=1
```
insert into t1 values(1);
```
8. создайте новую роль readonly
```
create role readonly;
```
9. дайте новой роли право на подключение к базе данных testdb
```
grant connect on database testdb to readonly;
```
10. дайте новой роли право на использование схемы testnm
```
grant usage on schema testnm to readonly;
```
11. дайте новой роли право на select для всех таблиц схемы testnm
```
grant select on all tables in schema testnm to readonly;
```
12. создайте пользователя testread с паролем test123
```
create role testread login password 'test123';
```
13. дайте роль readonly пользователю testread
```
grant readonly to testread;
```
14. зайдите под пользователем testread в базу данных testdb
```
psql -U testread -h 127.0.0.1 -d testdb
```
15. сделайте select * from t1;
```
testdb=> select * from t1;
ОШИБКА:  нет доступа к таблице t1
```
16. получилось? (могло если вы делали сами не по шпаргалке и не упустили один существенный момент про который позже)

**Не получилось, ошибка доступа**

17. напишите что именно произошло в тексте домашнего задания
18. у вас есть идеи почему? ведь права то дали?
19. посмотрите на список таблиц
```
testdb=> \d
        List of relations
 Schema | Name | Type  |  Owner   
--------+------+-------+----------
 public | t1   | table | postgres

```
20. подсказка в шпаргалке под пунктом 20
21. а почему так получилось с таблицей (если делали сами и без шпаргалки то может у вас все нормально)

**Роли readonly, в которую входит роль testread, дали права на чтение таблиц в схеме testnm, а таблица t1 находится в схеме public, на неё прав не давали.**

**Почему таблица t1 была создана в схеме public? В задании не было явно написано, в какой схеме нужно создать таблицу, поэтому я не указывала в запросе имя схемы, и по умолчанию таблица была создана в схеме, которая была первой существующей схемой в параметре search_path, то есть в public.**

22. вернитесь в базу данных testdb под пользователем postgres
23. удалите таблицу t1
```
drop table t1;
```
24. создайте ее заново но уже с явным указанием имени схемы testnm
```
create table testnm.t1 (c1 integer);
```
25. вставьте строку со значением c1=1
```
insert into testnm.t1 values(1);
```
26. зайдите под пользователем testread в базу данных testdb
27. сделайте select * from testnm.t1;
```
testdb=> select * from testnm.t1;
ОШИБКА:  нет доступа к таблице t1
```
28. получилось?
29. есть идеи почему? если нет - смотрите шпаргалку

**Не получилось, потому что таблица была создана уже после того, как роли readonly были даны права на чтение всех таблиц в схеме testnm. Права были выданы только на существующие таблицы, для новых таблиц они не применяются**

30. как сделать так чтобы такое больше не повторялось? если нет идей - смотрите шпаргалку

**Чтобы при создании новых таблиц в схеме testnm на них автоматически получала права на чтение роль readonly, нужно поменять привилегии по умолчанию, выдаваемые при создании таблиц.**

**Зашла в базу testdb под пользователем postgres, изменила привилегии по умолчанию для схемы testnm и для проверки создала таблицу t2:**
```
alter default privileges in schema testnm grant select on tables to readonly;
create table testnm.t2 (c2 integer);
insert into testnm.t2 values(2);
```
31. сделайте select * from testnm.t1; в базе testdb под пользователем testread
32. получилось?

**Прочитать данные из ранее созданной таблицы t1 не получилось, из новой таблицы t2 - получилось**

```
testdb=> select * from testnm.t1;
ОШИБКА:  нет доступа к таблице t1
testdb=> select * from testnm.t2;
 c2 
----
  2
(1 row)

```

33. есть идеи почему? если нет - смотрите шпаргалку

**Прочитать данные из таблицы t1 не получилось, потому что новые привилегии по умолчанию применяются к объектам, которые были созданы после их изменения, существующие объекты изменение привилегий по умолчанию не затрагивает.**

**Выдала права на чтение на таблицу t1 под пользователем postgres:**

```
grant select on testnm.t1 to readonly;
```

34. сделайте select * from testnm.t1; под пользователем testread
35. получилось?
36. ура!

**Получилось**

37. теперь попробуйте выполнить команду create table t2(c1 integer); insert into t2 values (2);
38. а как так? нам же никто прав на создание таблиц и insert в них под ролью readonly?

**Таблица была создана, потому что псевдороль public, в которую входят все пользователи, имеет права на использование схемы public и создание в ней объектов. Выполнить Insert получилось, потому что по умолчанию создатель таблицы является её владельцем, а владелец имеет все привилегии для этой таблицы.**

39. есть идеи как убрать эти права? если нет - смотрите шпаргалку

**Нужно явно отозвать у псевдороли public права на использование схемы public и создание в ней объектов. В случае необходимости выдать эти права конкретным ролям.**


40. если вы справились сами то расскажите что сделали и почему, если смотрели шпаргалку - объясните что сделали и почему выполнив указанные в ней команды


```
REVOKE ALL ON SCHEMA public FROM public;
```

41. теперь попробуйте выполнить команду create table t3(c1 integer); insert into t2 values (2);
42. расскажите что получилось и почему

```
testdb=> create table t3(c1 integer);
ОШИБКА:  схема для создания объектов не выбрана

testdb=> insert into t2 values (2);
ОШИБКА:  отношение "t2" не существует

```

**Не получилось создать новую таблицу и вставить данные в существующую, потому что нет прав на использование схемы public.**

## Для примера поменяла права доступа к схеме public:

- Отозвала у роли *public* все права на схему *public* (на предыдущем шаге).
- Выдала права роли *readonly* на использование схемы *public* и доступ на чтение к существующим в ней таблицам:
```
grant usage on schema public to readonly;
grant select on all tables in schema public to readonly;
```
- Создала роль *writers*, выдала ей права на использование и изменение схемы *public*:
```
create role writers;
grant connect on database testdb to writers;
grant all on schema public to writers;
```
- Сменила привилегии по умолчанию, выдаваемые при создании таблиц, чтобы роль *readonly* получала доступ на чтение к вновь созданным таблицам:
```
alter default privileges in schema public grant select on tables to readonly;
```
- Сделала владельцем существующей таблицы в схеме *public* роль *writers*:
```
alter table t2 owner to writers;
```

### Проверила, что получилось после изменения прав

- Создала пользователя *testwrite* с паролем *test123*, выдала ему роль *writers*:
```
create role testwrite login password 'test123';
grant writers to testwrite;
```
- Подключилась к БД *testdb* под пользователем *testwrite*, проверила права на изменение существующей таблицы и создание новой:
```
create table t3 (c1 integer);
insert into t3 values(1);
```
Успешно, удалось создать таблицу и вставить строки в новую и старую таблицы
- Подключилась к БД *testdb* под пользоваталем  *testread*, проверила, что есть права на чтение из старой и новой таблиц и отсутствуют права на создание и изменение таблиц:
```
select * from t2;
select * from t3;

testdb=> create table t4 (c1 integer);
ОШИБКА:  нет доступа к схеме public

testdb2=> insert into t2 values(4);
ОШИБКА:  нет доступа к таблице t2

testdb2=> insert into t3 values(4);
ОШИБКА:  нет доступа к таблице t3
```

### Дополнение:

В версии 15 роль PUBLIC лишена права создания объектов в схеме public. 
Это изменение распространяется на новые кластеры и на новые базы, которые будут создаваться в существующих кластерах. При обновлении кластера или восстановлении выгруженной ранее копии для схемы public сохранятся предыдущие разрешения.






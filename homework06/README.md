# Домашнее задание #6

## Работа с журналами


1. Настройте выполнение контрольной точки раз в 30 секунд.
```
checkpoint_timeout = 30s
```
2. 10 минут c помощью утилиты pgbench подавайте нагрузку.
```
pgbench -i postgres -s 50
pgbench -c8 -P 6 -T 600 -U postgres postgres
```
3. Измерьте, какой объем журнальных файлов был сгенерирован за это время. Оцените, какой объем приходится в среднем на одну контрольную точку.
```
SELECT * FROM pg_ls_waldir();
```
**15 файлов, размер 16 МБ каждый - итого 240 MB**

**В среднем на одну контрольную точку приходится 120 МБ**

**Журнальные файлы содержат записи за прошедшую завершенную точку и за текущую, ещё не завершенную, а система оценивает необходимое количество файлов, основываясь на среднем за предыдущие циклы контрольных точек.**


4. Проверьте данные статистики: все ли контрольные точки выполнялись точно по расписанию. Почему так произошло?

**По логу видно, что в то время, когда не подавалась нагрузка, контрольные точки  не выполнялись каждые 30 секунд, они выполнялись намного реже. Это происходило потому, что если после предыдущей контрольной точки новые записи WAL не добавились, то следующие контрольные точки будут пропущены, несмотря на то, что прошло время checkpoint_timeout.**

**Когда подавалась нагрузка, контрольные точки выполнялись точно по расписанию. Они могли бы выполняться чаще, если бы размер WAL приближался к пределу max_wal_size, но в данном тесте этого не произошло.**


5. Сравните tps в синхронном/асинхронном режиме утилитой pgbench. Объясните полученный результат.
```
-- synchronous_commit = on

number of transactions actually processed: 32939
number of failed transactions: 0 (0.000%)
latency average = 14.570 ms
latency stddev = 24.510 ms
initial connection time = 14.293 ms
tps = 548.965217 (without initial connection time)


-- synchronous_commit = off

number of transactions actually processed: 62343
number of failed transactions: 0 (0.000%)
latency average = 7.787 ms
latency stddev = 79.460 ms
initial connection time = 13.501 ms
tps = 1027.051167 (without initial connection time)
```
**В асинхронном режиме время отклика (latency) существенно меньше, а пропускная способность (tps) существенно выше, потому что фиксация изменений не ждет физической записи на диск. В синхронном режиме команда commit не возвращает управление до окончания синхронизации, что приводит к увеличению времени отклика и снижению производительности системы.**


6. Создайте новый кластер с включенной контрольной суммой страниц. Создайте таблицу. Вставьте несколько значений. Выключите кластер.Измените пару байт в таблице. Включите кластер и сделайте выборку из таблицы. Что и почему произошло? как проигнорировать ошибку и продолжить работу?
```
-- Включить проверку контрольных сумм:
sudo -u postgres /usr/lib/postgresql/15/bin/pg_checksums -e -P -D /var/lib/postgresql/15/main

-- Проверить, что контрольные суммы включены
show data_checksums;

-- Создать таблицу
create table test (id integer, name varchar(10));
insert into test values (1, 'aaa'), (2, 'bbb'), (3, 'ccc');

-- Получить имя файла, в котором хранятся данные
SELECT pg_relation_filepath('test');
 pg_relation_filepath 
----------------------
 base/5/16388

-- Изменить файл с таблицей
dd if=/dev/zero of=/var/lib/postgresql/15/main/base/5/16388 oflag=dsync conv=notrunc bs=1 count=8

-- Сделать выборку не получилось - получили ошибку, так как контрольные суммы не совпадают, страница повреждена:

select * from test;
WARNING:  page verification failed, calculated checksum 36866 but expected 56066
ERROR:  invalid page in block 0 of relation base/5/16388

-- Включить параметр, позволяющий игнорировать ошибки контрольных сумм:
set ignore_checksum_failure = on;

-- Выборку сделать получилось, но есть предупреждение об ошибке контрольной суммы

select * from test;
WARNING:  page verification failed, calculated checksum 36866 but expected 56066
 id | name 
----+------
  1 | aaa
  2 | bbb
  3 | ccc
(3 rows)


```

